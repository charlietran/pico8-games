pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
function _init()
 px=20 --player x pos
 py=56 --player y pos
 pstate=1 --current player state
 pspr=0 --current sprite
 pdir=0 --current direction
 pat=0 --player state timer
 
 --buttons
 b⬅️=0
 b➡️=0
 b⬆️=0
end

states={}
-- 1 idle
states[1] = {
 exec = function()
  pspr=0
  if(b⬅️ or b➡️)change_state(2)
  if(b⬆️)change_state(4)
  if(canfall())change_state(3)
 end
}
-- 2 walk
states[2]={
 exec=function()
  if(b⬅️)pdir=-1
  if(b➡️)pdir=1
  px += pdir * min(pat,2)
  pspr=flr(pat/2)%2
  
  if not(b⬅️ or b➡️) then 
   change_state(1)
  end
  if b⬆️ then 
   change_state(4)
  end
  if canfall() then
   change_state(3)   
  end
 end
}
-- 3 falling
states[3]={
 exec=function()
  pspr=2
  if canfall() then
   if(b⬅️) px-=1
   if(b➡️) px+=1
   --drop the player
   py+=min(4,pat)
   --check contact after drop
   if not canfall() then
    py=flr(py/8)*8
   end
  else
   py=flr(py/8)*8
   change_state(1)
  end
 end
}

-- 4 jump
states[4]={
 exec=function()
  if canrise() then
   pspr=2
   py-=6-pat
   if(b⬅️)px-=2
   if(b➡️)px+=2
   if not b⬆️ or pat>7 then
    change_state(1)
   end
  else
   change_state(1)
  end
 end
}

function _update()
 b⬅️=btn(⬅️)
 b➡️=btn(➡️)
 b⬆️=btn(⬆️)
 
 --no left/right bounds
 px=(px+128)%128
 
 --inc state clock
 pat+=1

 states[pstate].exec()
end

function _draw()
 --draw the world
 map(0,0,0,0,16,16)
 --draw the player
 spr(pspr,px,py,1,1,pdir==-1)
end

function change_state(s)
 pstate=s
 pat=0
end

function canfall()
 --get map tile under player
 t=mget(
    flr((px+4)/8),
    flr((py+8)/8))
 --see if tile is flagged
 return not fget(t,0)
end

function canrise()
 --get map tile above player
 t=mget(
    flr((px)/8),
    flr((py-1)/8))
 --see if tile is flagged
 return not fget(t,0)
end
__gfx__
00bbbb0000bbbb0000b77b00ccccccccccccccccc077cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb77bb00bb77bb00bb70bb0ccccccccccc77ccc0777777c00000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb70bb00bb70bb00bbbbbb0cccccccccc0777cc0777777c00000000000000000000000000000000000000000000000000000000000000000000000000000000
0bbbbbb00bbbbbb00bbbbbb0cccccccc777777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000
0bb3bb000bb3bb000b33bb00cccccccc707777700777777c00000000000000000000000000000000000000000000000000000000000000000000000000000000
00b3bb00004b3b0003bbbb00ccccccccc70007777000077c00000000000000000000000000000000000000000000000000000000000000000000000000000000
000bb0000044bb220022b000cccccccccc77777cc77777cc00000000000000000000000000000000000000000000000000000000000000000000000000000000
002222000555022000002200cccccccccccccccccccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaaaaaacaaaaaaaaaaaaaac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999c99999999999999c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999c99999999999999c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999cc999999999999cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999cc999999999999cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444cc444444444444cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222cc222222222222cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030405030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303040503030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303111003030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1110100303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303111203030304050303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303111003030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030311101003030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000131313131313130000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
